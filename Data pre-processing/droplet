library(Seurat)
library(rhdf5)

droplet.files = list.files(path = "D:/raw files",pattern = "drop.r")
droplet.files = droplet.files[-c(6,21,2,15,16)] #removing large intestine and trachea because they have only one age group and also fat,skin and pancreas.
drop_organs = sapply(droplet.files,function(f) unlist(strsplit(f,"[.]"))[1])
drop_organs = unname(drop_organs)

for(i in 1:length(drop_organs)){
  # Reading the meta data categories
  meta = h5read(paste0("D:raw files/",drop.files[i]),"uns")
  meta = meta[grep("categories",names(meta))]
  names(meta) = sapply(names(meta),function(name) substr(name,1,nchar(name) - 11))

  SC = ReadH5AD(paste0("D:/raw files/",drop.files[i]),assay = "RNA",verbose = F) # reading tissue file in to Seurat object
  
  # Our data is allready filltered so lets move on to normalizetion and finding highly variable features(feature selection).
  SC = NormalizeData(SC) # Size factor normalization to 10,000 counts and log transformation
  SC = FindVariableFeatures(SC,verbose = F) # Finding the 2000 highly variable features
  SC = ScaleData(SC) #scaling the data
  
  SC@active.ident = factor(SC@meta.data$cell.ontology.class,labels = meta$cell_ontology_class) # setting the ident to cell types 
  SC = AddMetaData(SC,metadata = ifelse(SC@meta.data$age%in%c("18m","21m","24m","30m"),"Old","Young"),col.name = "Age") #Adding Old/Young vector to meta data 
  SC = AddMetaData(SC,metadata = SC@active.ident,col.name = "Cells") #Adding cell type names to meta data
  SC$age = factor(SC$age,labels = meta$age) # naming the ages vector in meta data
  
 
  SC = RunPCA(SC,verbose = F) # Run PCA
  SC = RunTSNE(SC) # Run tsne
  SC = RunUMAP(SC,dims = 1:10) # Run umap 
 
  saveRDS(SC,file = paste(drop_organs[i],"drop","rds",sep = "."))
}
